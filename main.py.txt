import logging
import os
from dotenv import load_dotenv

from telegram import Update
from telegram.ext import (
    Application, CommandHandler, MessageHandler, ContextTypes, filters
)

# --- ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø§ÙˆÙ„ÛŒÙ‡ ---
logging.basicConfig(
    format="%(asctime)s - %(levelname)s - %(name)s - %(message)s",
    level=logging.INFO
)
logger = logging.getLogger(name)

# --- Ø®ÙˆØ§Ù†Ø¯Ù† ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø§Ø² .env ---
load_dotenv()
TOKEN = os.getenv("BOT_TOKEN")
ADMIN_ID = int(os.getenv("ADMIN_ID", "0"))

if not TOKEN or not ADMIN_ID:
    raise RuntimeError("BOT_TOKEN ÛŒØ§ ADMIN_ID Ø¯Ø± ÙØ§ÛŒÙ„ .env ØªÙ†Ø¸ÛŒÙ… Ù†Ø´Ø¯Ù‡!")

# --- Ù‡Ù†Ø¯Ù„Ø±Ù‡Ø§ ---
async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user = update.effective_user
    logger.info("User %s (%s) started the bot. id=%s",
                user.full_name, user.username, user.id)
    await update.message.reply_text(
        "Ø³Ù„Ø§Ù…! ğŸ‘‹\n"
        "Ø§ÛŒÙ†Ø¬Ø§ Ù‡Ø± Ø­Ø±ÙÛŒ Ø¯Ø§Ø±ÛŒ Ø¨Ù†ÙˆÛŒØ³Ø› Ù…Ù† Ù…Ø³ØªÙ‚ÛŒÙ… Ùˆ Ù†Ø§Ø´Ù†Ø§Ø³ Ù…ÛŒâ€ŒÙØ±Ø³ØªÙ… Ø¨Ø±Ø§ÛŒ Ø§ÛŒÙ…Ø§Ù†.\n"
        "Ø¨Ø±Ø§ÛŒ Ù„ØºÙˆ Ø§Ø±Ø³Ø§Ù„ Ø®ÙˆØ¯Ú©Ø§Ø±ØŒ ÙÙ‚Ø· /stop Ø±Ùˆ Ø¨Ø²Ù†."
    )

async def stop(update: Update, context: ContextTypes.DEFAULT_TYPE):
    await update.message.reply_text("Ø¨Ø§Ø´Ù‡. Ù‡Ø± ÙˆÙ‚Øª Ø®ÙˆØ§Ø³ØªÛŒ Ø¯ÙˆØ¨Ø§Ø±Ù‡ /start Ø±Ùˆ Ø¨Ø²Ù† ğŸ™‚")

async def feedback(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """Ù‡Ø± Ù¾ÛŒØ§Ù… Ù…ØªÙ†ÛŒ Ø±Ùˆ Ø¨Ù‡ Ø§ÛŒÙ…Ø§Ù† Ø§Ø±Ø³Ø§Ù„ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ…"""
    if not update.message or not update.message.text:
        return  # ÙÙ‚Ø· Ù…ØªÙ†â€ŒÙ‡Ø§ Ø±Ùˆ Ù…ÛŒâ€ŒÚ¯ÛŒØ±ÛŒÙ…

    user = update.effective_user
    text = update.message.text

    # Ø§Ø±Ø³Ø§Ù„ Ø¨Ù‡ Ø§ÛŒÙ…Ø§Ù†
    try:
        await context.bot.send_message(
            chat_id=ADMIN_ID,
            text=(
                "ğŸ“© *Ù¾ÛŒØ§Ù… Ø¬Ø¯ÛŒØ¯*\n"
                f"ğŸ‘¤ Ø§Ø²: {user.full_name} "
                f"{'(@'+user.username+')' if user.username else ''}\n"
                f"ğŸ†” Ø¢ÛŒØ¯ÛŒ: {user.id}\n\n"
                f"âœï¸ {text}"
            ),
            parse_mode="Markdown"
        )
    except Exception as e:
        logger.exception("Ø§Ø±Ø³Ø§Ù„ Ø¨Ù‡ Ø§Ø¯Ù…ÛŒÙ† Ù†Ø§Ù…ÙˆÙÙ‚ Ø¨ÙˆØ¯: %s", e)

    # Ø¬ÙˆØ§Ø¨ Ø¨Ù‡ Ú©Ø§Ø±Ø¨Ø±
    await update.message.reply_text("Ù…Ø±Ø³ÛŒ! Ù¾ÛŒØ§Ù…Øª Ø«Ø¨Øª Ø´Ø¯ âœ…")

# --- Ø§Ø¬Ø±Ø§ÛŒ Ø¨Ø±Ù†Ø§Ù…Ù‡ ---
def main():
    app = Application.builder().token(TOKEN).build()

    app.add_handler(CommandHandler("start", start))
    app.add_handler(CommandHandler("stop", stop))
    app.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, feedback))

    logger.info("Bot is up and running...")
    app.run_polling(allowed_updates=Update.ALL_TYPES)

if name == "main":
    main()